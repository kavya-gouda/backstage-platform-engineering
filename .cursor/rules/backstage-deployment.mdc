---
description: Backstage AKS deployment patterns (Terraform, Helm)
globs: terraform/**/*.tf,terraform/**/*.tfvars*,helm/**/*.yaml,.github/workflows/*.yml
alwaysApply: false
---

# Backstage Platform Deployment

## Terraform & Helm

- **Readiness probe**: Backstage needs 2+ minutes for DB migrations and plugin loading. Set `backstage.readinessProbe.initialDelaySeconds = 120` to avoid 503 loops.
- **PostgreSQL secret**: Use `postgresql.auth.existingSecret` with a Kubernetes secret containing `user-password` and `admin-password` keys (Bitnami chart expects these).
- **Auth for demo**: `backstage.appConfig.backend.auth.dangerouslyDisableDefaultAuthPolicy: true` when no auth provider. Set `false` when `github_auth_enabled`.
- **GitHub auth**: Set `github_auth_enabled`, `github_client_id`, `github_client_secret`. Use `backstage_base_url_override` for LoadBalancer so OAuth callback URL matches. See docs/GITHUB_AUTH_SETUP.md.

## Access

- **LoadBalancer** (default when ingress disabled): `backstage_service_loadbalancer = true` avoids port-forward. Run `kubectl get svc -n backstage -w` for EXTERNAL-IP.
- **Port-forward**: Use when `backstage_service_loadbalancer = false` or ingress disabled.

## Troubleshooting

- **Readiness 503**: Check `kubectl logs deploy/backstage -c backstage-backend --tail=2000` for startup errors. Ensure DB connectivity and migrations complete.
- **PostgreSQL secret error**: Delete stale `backstage-postgresql` secret if switching to `existingSecret`. Terraform-managed secret must have keys `user-password` and `admin-password`.
